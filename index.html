<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caim√°nCuentacuentos Pro üêä</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --p: #2e7d32; --s: #ffa000; --blue: #1565c0; }
        body { font-family: 'Comic Sans MS', 'Chalkboard SE', cursive, sans-serif; background: #e8f5e9; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { max-width: 750px; width: 100%; background: white; padding: 30px; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); text-align: center; border: 8px solid #c8e6c9; }
        h1 { color: var(--p); font-size: 2.2em; margin-bottom: 5px; }
        .input-group { background: #fff3e0; padding: 20px; border-radius: 20px; margin: 20px 0; border: 2px dashed var(--s); }
        input[type="text"] { width: 85%; padding: 15px; border-radius: 15px; border: 2px solid #ddd; outline: none; font-size: 1.1em; }
        #canvas-wrap { border: 6px solid var(--p); border-radius: 20px; margin: 20px 0; background: white; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        canvas { display: block; max-width: 100%; height: auto; cursor: crosshair; background: white; }
        .btn-zone { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
        button { padding: 12px 25px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; color: white; text-transform: uppercase; box-shadow: 0 4px 0 #1b5e20; }
        button:active { transform: translateY(4px); box-shadow: none; }
        .btn-main { background: var(--p); font-size: 1.1em; }
        .btn-nav { background: #555; box-shadow: 0 4px 0 #333; }
        .btn-share { background: var(--blue); box-shadow: 0 4px 0 #0d47a1; }
        .btn-pdf { background: var(--s); color: #333; box-shadow: 0 4px 0 #e65100; }
        button:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }
        #story-txt { font-size: 1.25em; margin: 20px 0; color: #333; min-height: 80px; line-height: 1.5; padding: 0 15px; font-weight: 500; }
        .status { color: #d32f2f; font-weight: bold; margin: 15px 0; display: none; background: #ffebee; padding: 10px; border-radius: 10px; }
    </style>
</head>
<body>

<div class="card">
    <h1>üêä Caim√°nCuentacuentos</h1>
    
    <div class="input-group">
        <input type="text" id="topic" placeholder="Ej: Un caim√°n que quiere volar...">
        <div class="btn-zone">
            <button class="btn-main" id="createBtn" onclick="buildFullStory()">‚ú® CREAR CUENTO M√ÅGICO</button>
        </div>
    </div>

    <div id="loader" class="status">ü™Ñ Mi magia est√° trabajando... (esto tarda 1 minuto)</div>

    <div id="book-viewer">
        <h2 id="page-label">Bienvenido</h2>
        <div id="story-txt">Escribe una idea arriba para inventar un libro juntos.</div>
        
        <div id="canvas-wrap">
            <canvas id="paintCanvas" width="600" height="400"></canvas>
        </div>

        <div class="btn-zone" id="nav-controls" style="display:none;">
            <button class="btn-nav" id="prevBtn" onclick="move(-1)">‚¨ÖÔ∏è Anterior</button>
            <input type="color" id="brushColor" value="#2e7d32" style="width:50px; height:45px; border-radius:10px; border:none; cursor:pointer;">
            <button class="btn-nav" onclick="clearC()">üßπ Borrar</button>
            <button class="btn-nav" id="nextBtn" onclick="move(1)">Siguiente ‚û°Ô∏è</button>
        </div>

        <div id="author-zone" style="margin-top:30px; display:none;">
            <hr style="border:1px solid #eee;">
            <h3>üì§ ¬°Libro Terminado!</h3>
            <div class="btn-zone">
                <button class="btn-share" id="shareBtn" onclick="copyLink()">üìã COPIAR ENLACE PARA EL NI√ëO</button>
                <button class="btn-pdf" id="pdfBtn" onclick="savePDF()">üì• GUARDAR COMO PDF</button>
            </div>
        </div>
    </div>
</div>

<script>
    // TUS LLAVES ACTUALIZADAS
    const G_KEY = "AIzaSyANHfYhYRkoHZ4WfwqpPFOKxE-YeRkyfQw";
    const H_TOKEN = "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";

    let book = { title: "", pages: [], images: [] };
    let cur = 0;
    const canv = document.getElementById('paintCanvas');
    const ctx = canv.getContext('2d');
    let drawing = false;

    window.onload = () => {
        const params = new URLSearchParams(window.location.search);
        if (params.has('data')) {
            try {
                book = JSON.parse(atob(params.get('data')));
                document.querySelector('.input-group').style.display = 'none';
                startReading();
            } catch(e) { console.error("Error cargando link"); }
        }
    };

    async function queryHuggingFace(payload) {
        let retries = 3;
        while(retries > 0) {
            const res = await fetch("https://api-inference.huggingface.co/models/runwayml/stable-diffusion-v1-5", {
                method:"POST", headers:{"Authorization":`Bearer ${H_TOKEN}`},
                body: JSON.stringify(payload)
            });
            if (res.status === 503) { 
                await new Promise(r => setTimeout(r, 5000));
                retries--;
                continue;
            }
            return await res.blob();
        }
    }

    async function buildFullStory() {
        const topic = document.getElementById('topic').value;
        if(!topic) return alert("¬°Pon una idea para el cuento!");
        
        const loader = document.getElementById('loader');
        const btn = document.getElementById('createBtn');
        loader.style.display = "block";
        btn.disabled = true;

        try {
            // 1. Gemini
            const prompt = `Escribe un cuento infantil corto sobre ${topic}. Dividido en 5 escenas. Devuelve un JSON estrictamente as√≠: {"titulo": "T√≠tulo corto", "escenas": ["escena 1", "escena 2", "escena 3", "escena 4", "escena 5"]}`;
            const gRes = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${G_KEY}`, {
                method:"POST", headers:{"Content-Type":"application/json"},
                body: JSON.stringify({contents:[{parts:[{text:prompt}]}]})
            });
            const gData = await gRes.json();
            let rawText = gData.candidates[0].content.parts[0].text;
            const cleanJson = rawText.match(/\{.*\}/s)[0];
            const parsed = JSON.parse(cleanJson);
            
            book.title = parsed.titulo;
            book.pages = [parsed.titulo, ...parsed.escenas];
            book.images = [];

            // 2. Im√°genes
            for(let i=0; i<6; i++) {
                loader.innerText = `üñåÔ∏è Dibujando imagen ${i+1} de 6...`;
                const style = (i===0) ? "Digital art, Pixar style, colorful, cute" : "Coloring book style, black and white, thick lines, simple for kids";
                const blob = await queryHuggingFace({inputs: `${style}, ${book.pages[i]}`});
                
                book.images.push(await new Promise(r => {
                    const rd = new FileReader(); rd.onloadend = () => r(rd.result); rd.readAsDataURL(blob);
                }));
            }

            loader.style.display = "none";
            startReading();
            document.getElementById('author-zone').style.display = 'block';
            
        } catch (e) { 
            console.error(e);
            alert("¬°Ups! Hubo un problema. Revisa que tus llaves est√©n activas.");
            loader.style.display = "none";
            btn.disabled = false;
        }
    }

    function startReading() {
        document.getElementById('nav-controls').style.display = 'flex';
        showPage(0);
    }

    function showPage(idx) {
        cur = idx;
        document.getElementById('page-label').innerText = (idx === 0) ? "üìñ PORTADA" : `P√ÅGINA ${idx}`;
        document.getElementById('story-txt').innerText = book.pages[idx];
        const img = new Image();
        img.onload = () => { ctx.clearRect(0,0,600,400); ctx.drawImage(img,0,0,600,400); };
        img.src = book.images[idx];
    }

    function move(dir) {
        let n = cur + dir;
        if(n >= 0 && n < 6) showPage(n);
    }

    // PINTAR
    canv.onmousedown = (e) => { if(cur!==0) { drawing = true; startPaint(e); } };
    canv.onmouseup = () => { drawing = false; ctx.beginPath(); };
    canv.onmousemove = (e) => { if(drawing) paint(e); };
    
    canv.ontouchstart = (e) => { if(cur!==0) { drawing = true; startPaint(e.touches[0]); e.preventDefault(); } };
    canv.ontouchend = () => { drawing = false; ctx.beginPath(); };
    canv.ontouchmove = (e) => { if(drawing) { paint(e.touches[0]); e.preventDefault(); } };

    function startPaint(e) {
        const r = canv.getBoundingClientRect();
        ctx.beginPath();
        ctx.moveTo(e.clientX - r.left, e.clientY - r.top);
    }

    function paint(e) {
        ctx.strokeStyle = document.getElementById('brushColor').value;
        ctx.lineWidth = 4; ctx.lineCap = 'round';
        const r = canv.getBoundingClientRect();
        ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
        ctx.stroke();
    }

    function clearC() { showPage(cur); }

    function copyLink() {
        const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(book))));
        const url = window.location.href.split('?')[0] + "?data=" + encoded;
        navigator.clipboard.writeText(url);
        alert("¬°Enlace listo! P√©galo en WhatsApp.");
    }

    function savePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', [210, 148]); 
        doc.setFont("helvetica", "bold");
        doc.text(book.title, 105, 20, {align: 'center'});
        doc.addImage(canv.toDataURL("image/png"), 'PNG', 15, 30, 180, 100);
        doc.save(`Cuento-${book.title}.pdf`);
    }
</script>
</body>
</html>
