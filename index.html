<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Caim√°nCuentacuentos Pro üêä</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root { --p: #2e7d32; --s: #ffa000; --blue: #1565c0; }
        body { font-family: 'Comic Sans MS', cursive, sans-serif; background: #e8f5e9; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .card { max-width: 750px; width: 100%; background: white; padding: 30px; border-radius: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); text-align: center; border: 8px solid #c8e6c9; }
        h1 { color: var(--p); font-size: 2.2em; margin-bottom: 5px; }
        .input-group { background: #fff3e0; padding: 20px; border-radius: 20px; margin: 20px 0; border: 2px dashed var(--s); }
        input[type="text"] { width: 80%; padding: 15px; border-radius: 15px; border: 2px solid #ddd; outline: none; font-size: 1.1em; margin: 5px; }
        #canvas-wrap { border: 6px solid var(--p); border-radius: 20px; margin: 20px 0; background: white; overflow: hidden; }
        canvas { display: block; max-width: 100%; height: auto; cursor: crosshair; background: white; }
        .btn-zone { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 20px; }
        button { padding: 12px 25px; border-radius: 50px; border: none; font-weight: bold; cursor: pointer; transition: 0.3s; color: white; text-transform: uppercase; }
        .btn-main { background: var(--p); font-size: 1.1em; box-shadow: 0 4px 0 #1b5e20; }
        .btn-nav { background: #555; box-shadow: 0 4px 0 #333; }
        .btn-share { background: var(--blue); box-shadow: 0 4px 0 #0d47a1; }
        .btn-pdf { background: var(--s); color: #333; box-shadow: 0 4px 0 #e65100; }
        button:active { transform: translateY(4px); box-shadow: none; }
        #story-txt { font-size: 1.25em; margin: 20px 0; color: #333; min-height: 60px; padding: 0 15px; }
        .status { color: #2e7d32; font-weight: bold; margin: 15px 0; display: none; }
    </style>
</head>
<body>

<div class="card">
    <h1>üêä Caim√°nCuentacuentos</h1>
    
    <div class="input-group">
        <input type="text" id="authorName" placeholder="Tu nombre (Autora)">
        <input type="text" id="topic" placeholder="Ej: Un elefante azul...">
        <div class="btn-zone">
            <button class="btn-main" onclick="generateDemo()">‚ú® CREAR CUENTO (MODO PRUEBA)</button>
        </div>
    </div>

    <div id="loader" class="status">ü™Ñ Preparando tu libro...</div>

    <div id="book-viewer">
        <h2 id="page-label">Bienvenido</h2>
        <div id="story-txt">Escribe tu nombre y una idea para empezar.</div>
        
        <div id="canvas-wrap">
            <canvas id="paintCanvas" width="600" height="400"></canvas>
        </div>

        <div class="btn-zone" id="nav-controls" style="display:none;">
            <button class="btn-nav" onclick="move(-1)">‚¨ÖÔ∏è Anterior</button>
            <input type="color" id="brushColor" value="#2e7d32" style="width:50px; height:45px; border-radius:10px; border:none; cursor:pointer;">
            <button class="btn-nav" onclick="clearCanvas()">üßπ Borrar</button>
            <button class="btn-nav" onclick="move(1)">Siguiente ‚û°Ô∏è</button>
        </div>

        <div id="author-zone" style="margin-top:30px; display:none;">
            <hr style="border:1px solid #eee; margin-bottom: 20px;">
            <h3 id="display-author" style="color: var(--p)"></h3>
            <div class="btn-zone">
                <button class="btn-share" onclick="copyLink()">üìã COPIAR ENLACE PARA EL NI√ëO</button>
                <button class="btn-pdf" onclick="savePDF()">üì• GUARDAR COMO PDF</button>
            </div>
        </div>
    </div>
</div>

<script>
    // Sin llaves para que no falle
    let book = { title: "", author: "", pages: [], images: [] };
    let cur = 0;
    const canv = document.getElementById('paintCanvas');
    const ctx = canv.getContext('2d');
    let drawing = false;

    function generateDemo() {
        const topic = document.getElementById('topic').value || "Cuento M√°gico";
        const author = document.getElementById('authorName').value || "Autora An√≥nima";
        const loader = document.getElementById('loader');
        
        loader.style.display = "block";
        
        // Simulamos la carga para mostrar todos los botones
        setTimeout(() => {
            book.title = topic;
            book.author = author;
            book.pages = [
                `Portada: ${topic}`,
                "Hab√≠a una vez un personaje muy especial...",
                "Le gustaba mucho jugar y explorar el mundo.",
                "Un d√≠a, encontr√≥ un tesoro escondido.",
                "Comparti√≥ su alegr√≠a con todos sus amigos.",
                "Y vivieron felices para siempre."
            ];
            // Imagen de prueba blanca para colorear
            book.images = Array(6).fill("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAlgAAAGQAQMAAAAnX66uAAAAA1BMVEX///+nxBvIAAAAAXRSTlMAQObYZgAAADlJREFUeNrtwQEBAAAAgiD/r25IQAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAfBuCAAAB06969AAAAABJRU5ErkJggg==");
            
            loader.style.display = "none";
            document.getElementById('nav-controls').style.display = 'flex';
            document.getElementById('author-zone').style.display = 'block';
            document.getElementById('display-author').innerText = "Escrito por: " + author;
            showPage(0);
        }, 1000);
    }

    function showPage(idx) {
        cur = idx;
        document.getElementById('page-label').innerText = (idx === 0) ? "üìñ PORTADA" : `P√ÅGINA ${idx}`;
        document.getElementById('story-txt').innerText = book.pages[idx];
        const img = new Image();
        img.onload = () => { ctx.clearRect(0,0,600,400); ctx.drawImage(img,0,0,600,400); };
        img.src = book.images[idx];
    }

    function move(dir) {
        let n = cur + dir;
        if(n >= 0 && n < 6) showPage(n);
    }

    // Dibujo digital
    canv.onmousedown = (e) => { drawing = true; paint(e); };
    canv.onmouseup = () => { drawing = false; ctx.beginPath(); };
    canv.onmousemove = (e) => { if(drawing) paint(e); };

    function paint(e) {
        ctx.strokeStyle = document.getElementById('brushColor').value;
        ctx.lineWidth = 5; ctx.lineCap = 'round';
        const r = canv.getBoundingClientRect();
        ctx.lineTo(e.clientX - r.left, e.clientY - r.top);
        ctx.stroke();
    }

    function clearCanvas() { showPage(cur); }

    function copyLink() {
        alert("¬°Enlace generado! (En modo prueba se copia la URL actual)");
        navigator.clipboard.writeText(window.location.href);
    }

    function savePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('l', 'mm', [210, 148]);
        doc.text(book.title, 105, 15, {align: 'center'});
        doc.text("Por: " + book.author, 105, 25, {align: 'center'});
        doc.addImage(canv.toDataURL("image/png"), 'PNG', 15, 35, 180, 100);
        doc.save(`Cuento-${book.author}.pdf`);
    }
</script>
</body>
</html>
